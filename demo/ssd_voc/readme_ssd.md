sd的一切

### 设计
**关于总体结构**
1. ssd的总体结构：vgg16 + cls_head(3x3) + bbox_head(3x3)
2. vgg16主要是基于2组3x3和3组3x3的两种模块，分别模拟5x5, 7x7的滤波核进行特征学习，同时修改vgg16增加额外的几层3x3来实现下采样获取多尺度特征层。
   最终提取到6层多尺度特征图()
   同时在vgg16基础骨架上增加了一层l2_norm主要用来处理第0层特征层的输出，因为第0层输出的激活值相比其他层大，为了让多个特征层的激活值在统一水平范围，
   就只在第0层增加一层归一化l2_norm，他的操作就是
3. 分类、回归头很简单，只用3x3进行层数调整，然后就是permute/reshape/concate即获得各个头的特征输出(b,-1,2),(b,-1,4),(b,-1,10)


**关于如何定义训练target**
1. cls_score的target: 每个anchor的类别概率的预测是典型分类问题，

2. bbox_pred的target: bbox的4点位置坐标的预测是典型回归问题，

3. landmark的target: 关键点的5点坐标的预测是典型回归问题，


**关于anchor尺寸和生成机制**
1. ssd作为通用性目标检测算法


**关于输入图片尺寸**
1. 训练的时候，把图片强制到300*300，主要是为了batch图片能够叠加进行训练。而获取300*300的方式是：
    - 直接resize到300*300 
    - 这种处理图片的方式有一定的缺陷，因为图片会产生比例上的改变，这对训练样本中人脸的bbox尺寸也改变了，也就导致训练的样本跟实际的样本之间有比例上的差别。
      比如训练的车子有可能被在水平方向挤压，偏方形(图片是挤压过的300*300），而实际车子的形状则是长方形。

2. 测试的时候，由于不需要对图片进行堆叠，只是单图进行预测计算，所以理论上不需要强制图片尺寸到300*300。
    - 但SSD有个问题在于前向计算的多尺度特征图的最后一层默认下采样到(b,c,1,1)，也就是基于300*300计算得到w,h=1, 下采样比例是1/300，这个下采样比例太高，所以如果
      测试的图片小于300，在ssd中就会导致计算最后一层特征层时报错，因为w,h小于1了。因此测试的时候一般是缩放到300*300(不能是300以内)。


**缺陷**
1. 对小物体的检测效果不太好：根源是多级特征没有融合，高级语义特征无法被低层特征使用。改进方式是增加特征融合模块，比如FPN+SSH
2. 图片预处理方式不太好：直接改变比例缩放到300*300, 样本的比例改变可能对训练有影响。可以考虑用切出300*300或更小的方式(并保证至少有1个gt_bbox)进行预处理，保证图片比例不变。

### 调试

1. 当前模型(输入图片300*300)基于voc评价方式(iou>=0.5)在第epoch61的验证集精度：map=0.664 (未增加任何数据增强)
    +-------------+------+-------+--------+-----------+-------+
    | class       | gts  | dets  | recall | precision | ap    |
    +-------------+------+-------+--------+-----------+-------+
    | aeroplane   | 285  | 813   | 0.804  | 0.282     | 0.733 |
    | bicycle     | 337  | 1324  | 0.864  | 0.220     | 0.750 |
    | bird        | 459  | 1823  | 0.752  | 0.189     | 0.612 |
    | boat        | 263  | 2274  | 0.806  | 0.093     | 0.563 |
    | bottle      | 469  | 4203  | 0.633  | 0.071     | 0.348 |
    | bus         | 213  | 1023  | 0.873  | 0.182     | 0.752 |
    | car         | 1201 | 4230  | 0.887  | 0.252     | 0.803 |
    | cat         | 358  | 1007  | 0.911  | 0.324     | 0.837 |
    | chair       | 756  | 9293  | 0.750  | 0.061     | 0.391 |
    | cow         | 244  | 1189  | 0.914  | 0.188     | 0.671 |
    | diningtable | 206  | 2085  | 0.850  | 0.084     | 0.657 |
    | dog         | 489  | 1653  | 0.912  | 0.270     | 0.789 |
    | horse       | 348  | 1501  | 0.917  | 0.213     | 0.840 |
    | motorbike   | 325  | 1319  | 0.868  | 0.214     | 0.768 |
    | person      | 4528 | 18696 | 0.855  | 0.207     | 0.715 |
    | pottedplant | 480  | 3909  | 0.629  | 0.077     | 0.329 |
    | sheep       | 242  | 1034  | 0.777  | 0.182     | 0.587 |
    | sofa        | 239  | 1505  | 0.891  | 0.142     | 0.659 |
    | train       | 282  | 1290  | 0.911  | 0.199     | 0.823 |
    | tvmonitor   | 308  | 1720  | 0.815  | 0.146     | 0.661 |
    +-------------+------+-------+--------+-----------+-------+
    | mAP         |      |       |        |           | 0.664 |
    +-------------+------+-------+--------+-----------+-------+




